package org.example.chatbot.util;

/**
 * GPT에게 전달할 프롬프트 문자열을 생성하는 유틸리티 클래스입니다.
 * 사용자의 질문으로부터 intent, 날짜, 시간대, 키워드를 통합 추출하기 위한 프롬프트를 생성합니다.
 */
public class GptPromptBuilder {

    /**
     * 사용자의 질문에서 intent, 날짜, 시간대, 키워드를 한 번에 추출하는 프롬프트를 생성합니다.
     * GPT는 JSON 형태로 응답해야 합니다.
     */
    public static String buildIntentAndKeywordPrompt(String userInput) {
        return """
        너는 한경국립대학교 챗봇 시스템의 정보 추출기 역할을 맡고 있어.
        사용자의 질문을 분석해서 반드시 다음 4가지 항목을 JSON 형식으로 정확히 추출해줘:

        1. intent: 질문의 의도를 아래 목록 중 하나로만 지정해줘.
            - 학사공지, 학사일정, 기숙사식당, 교직원식당, 한경공지, 장학공지, 학생식당, 식당 미지정, 없음
            - intent는 반드시 위 목록 중 하나로만 반환하고, 다른 단어나 문장을 절대 포함하지 마.
            - 질문에 식당명이 포함되면 intent는 반드시 해당 식당명으로 지정해야 해.
                예) "기숙사식당" → intent: 기숙사식당 / "교직원식당" → intent: 교직원식당
            - 질문에 학사공지, 장학공지, 한경공지 키워드가 포함되면 intent는 반드시 해당 공지명으로 지정해야 해.
                예) "학사공지에 휴학 내용 있어?" → intent: 학사공지
            - 질문이 식단에 대한 내용이나 음식명을 포함하지만 식당명이 언급되지 않았다면 intent는 반드시 '식당 미지정'으로 지정해.
            - 질문이 공지사항/일정 관련 내용인데 공지 종류가 명확하지 않으면 intent는 '없음'으로 지정해.
            - 질문에 '일정'이라는 단어가 포함되어 있으면 공지 종류와 관계없이 intent는 반드시 '학사일정'으로 지정해.
            - intent에는 공지명/식당명만 포함하고, 검색 키워드나 일반 단어는 절대 포함하지 마.

        2. date: 질문에 날짜 표현(오늘, 내일, 7월, 7월 6일 등)이 있으면 YYYY-MM-DD 또는 YYYY-MM 형식으로 추출하고, 없으면 반드시 null로 반환해.

        3. mealTime: 질문에 아침/점심/저녁 등의 시간대 표현이 있으면 추출하고, 없으면 반드시 null로 반환해.

        4. keyword: 질문에 특정 공지 키워드(휴학, 등록금, 졸업, 학위수여 등)나 음식명(제육볶음, 돈까스 등)이 포함되어 있으면 한 단어나 간단한 구로 추출하고, 없으면 반드시 null로 반환해.
            - keyword는 intent와 중복되면 안 돼. intent에 들어간 식당명/공지명은 keyword로 지정하지 마.
            - keyword는 검색에 필요한 핵심 단어로만 지정하고, "메뉴", "식단", "밥" 등 일반 단어만 있는 경우에는 반드시 null로 반환해.

        🔒 출력은 반드시 아래 예시 형태의 JSON으로만 반환하고, JSON 이외의 텍스트는 절대 포함하지 마.
        예시1:
        {
            "intent": "장학공지",
            "date": "2025-07-01",
            "mealTime": null,
            "keyword": "등록금"
        }
        예시2:
        {
            "intent": "기숙사식당",
            "date": null,
            "mealTime": "점심",
            "keyword": "돈까스"
        }
        예시3:
        {
            "intent": "식당 미지정",
            "date": "2025-07-06",
            "mealTime": "저녁",
            "keyword": null
        }

        사용자 질문:
        "%s"
        """.formatted(userInput);
    }

    /**
     * GPT fallback 응답을 생성하기 위한 프롬프트입니다.
     * (의도 분류 실패 또는 관련 테이블이 없을 경우)
     */
    public static String buildFallbackPrompt(String userInput) {
        return """
        다음은 사용자가 입력한 질문입니다:
        "%s"

        이 질문은 우리 데이터베이스에 등록된 정보와 직접적으로 관련이 없기 때문에,
        친절하고 간결한 설명으로 답변해줘.

        사용자가 한경국립대학교 학생임을 고려해 학내 정보, 주변 시설, 생활 편의 정보로 도움을 줘.
        """.formatted(userInput);
    }
}